<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Complex Space-Time Interactions in a Cox Model • bamlss</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Complex Space-Time Interactions in a Cox Model">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bamlss</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/bamlss.html">Get started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/terms.html">Available Model Terms</a>
    </li>
    <li>
      <a href="../articles/families.html">Families</a>
    </li>
    <li>
      <a href="../articles/bf.html">BAMLSS Model Frame</a>
    </li>
    <li>
      <a href="../articles/engines.html">Estimation Engines</a>
    </li>
    <li>
      <a href="../articles/distregvis.html">Visualization with distreg.vis</a>
    </li>
    <li>
      <a href="../articles/glm.html">Generalized Linear Models (+)</a>
    </li>
    <li>
      <a href="../articles/multinomial.html">Bayesian Multinomial Regression</a>
    </li>
    <li>
      <a href="../articles/rent.html">Munich Rent Example</a>
    </li>
    <li>
      <a href="../articles/zn.html">Spatial Location-Scale Model</a>
    </li>
    <li>
      <a href="../articles/fatalities.html">Fatalities Model for Austria</a>
    </li>
    <li>
      <a href="../articles/misc.html">Miscellaneous Topics</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Publications
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/jm.html">Bayesian Joint Models for Longitudinal and Survival Data</a>
    </li>
    <li>
      <a href="../articles/bivnorm.html">Bivariate Gaussian Models for Wind Vectors</a>
    </li>
    <li>
      <a href="../articles/cox.html">Complex Space-Time Interactions in a Cox Model</a>
    </li>
    <li>
      <a href="../articles/lasso.html">LASSO-Type Penalization in the Framework of GAMLSS</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Complex Space-Time Interactions in a Cox Model</h1>
            
      
      
      <div class="hidden name"><code>cox.Rmd</code></div>

    </div>

    
    
<div id="intro" class="section level2">
<h2 class="hasAnchor">
<a href="#intro" class="anchor"></a>Intro</h2>
<p>In the article <strong>BAMLSS: Bayesian Additive Models for Location, Scale, and Shape (and Beyond)</strong> <span class="citation">(Umlauf, Klein, and Zeileis 2018)</span> an example based on the article of <span class="citation">Taylor (2017)</span> is used to illustrate the BAMLSS framework with complex space-time interactions in a Cox model.</p>
<p>The example uses data from the <em>London Fire Brigade</em> (LFB, <a href="http://www.london-fire.gov.uk/" class="uri">http://www.london-fire.gov.uk/</a>), which is one of largest fire brigades in the world. Each year, the LFB is called thousands of times, in most cases due to dwelling fires. To prevent further damage or fatal casualties, a short arrival time is important, i.e., the time it takes until a fire engine arrives at the scene after an emergency call has been received. The aim of this analysis is to explore the drivers of arrival times.</p>
</div>
<div id="model" class="section level2">
<h2 class="hasAnchor">
<a href="#model" class="anchor"></a>Model</h2>
<p>The response times are analyzed within a survival context where the hazard of an event (fire engine arriving) at time <span class="math inline">\(t\)</span> follows a relative risk model of the form <span class="math display">\[
\lambda(t) = \exp\left(\eta(t)\right) =  \exp\left( \eta_{\lambda}(t) + \eta_{\gamma} \right),
\]</span> i.e., a model for the instantaneous arrival rate conditional on the engine not having arrived before time <span class="math inline">\(t\)</span>. Here, the hazard function is assumed to depend on a time-varying predictor <span class="math inline">\(\eta_{\lambda}(t)\)</span> and a time-constant predictor <span class="math inline">\(\eta_{\gamma}\)</span>.</p>
<p>We set up a model with the time-constant predictor <span class="math display">\[
\eta_{\gamma} = \beta_0 + f_1(\texttt{fsintens}) + f_2(\texttt{daytime}) +
  f_3(\texttt{lon}, \texttt{lat}) + f_4(\texttt{daytime}, \texttt{lon}, \texttt{lat}),
\]</span> where <span class="math inline">\(\beta_0\)</span> is an intercept and function <span class="math inline">\(f_1( \cdot )\)</span> is the effect of fire station intensity (<code>fsintens</code>, computed with a kernel density estimate of all fire stations in London). The other variables represent: The time of the day (<code>daytime</code>), exact spatial coordinates of the fire (<code>lon</code> and <code>lat</code>). Here function <span class="math inline">\(f_4( \cdot )\)</span> is a three-dimensional interaction effect.</p>
<p>The time-varying additive predictor has the following form <span class="math display">\[
\eta_{\lambda}(\texttt{arrivaltime}) = f_0(\texttt{arrivaltime}) + f_1(\texttt{arrivaltime}, \texttt{lon}, \texttt{lat}),
\]</span> where <span class="math inline">\(f_0( \cdot )\)</span> is the baseline hazard for variable <code>arrivaltime</code>, the waiting time until the first fire engine arrives after the received emergency call.</p>
<p>The probability that the engine will arrive on the scene after time <span class="math inline">\(t\)</span> is described by the survival function <span class="math display">\[\begin{equation} \label{eqn:surv}
S(t) = \mathrm{Prob}(T &gt; t) = \exp \, \left( -\int_0^t \lambda(u)du \right),
\end{equation}\]</span> which is of prime interest in this analysis.</p>
</div>
<div id="data" class="section level2">
<h2 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h2>
<p>The data is freely available from the London DataStore (<a href="http://data.london.gov.uk/" class="uri">http://data.london.gov.uk/</a>) under the UK Open Government Licence (OGL v2). It can be downloaded from <a href="http://data.london.gov.uk/dataset/london-fire-brigade-incident-records" class="uri">http://data.london.gov.uk/dataset/london-fire-brigade-incident-records</a> which also contains previous years. The preprocessed data is part of the <em>bamlss</em> package and can be loaded with</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(LondonFire, <span class="dt">package =</span> <span class="st">"bamlss"</span>)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(LondonFire)</a></code></pre></div>
<pre><code>##                   coordinates arrivaltime   daytime  fsintens
## 12279 (-0.09832153, 51.65413)    6.033333 0.1263889  248.6067
## 12280 (-0.04467665, 51.48959)    3.400000 0.3266667 1646.1975
## 12281  (-0.1101969, 51.47268)    4.383333 0.4641667 1333.3776
## 12282  (-0.2448571, 51.45319)    5.800000 1.9297222  300.6900
## 12283  (-0.1874054, 51.48648)    5.133333 1.9308333 1195.7156
## 12284  (-0.2893525, 51.61031)    4.966667 3.5480556  319.6787</code></pre>
<p>and is stored as a <code>"SpatialPointsDataFrame"</code>. Therefore, the spatial distribution of fires in London along with boundary polygons and station locations can be plotted instantly with:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"sp"</span>)</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mar =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/plot">plot</a></span>(LondonBoundaries)</a>
<a class="sourceLine" id="cb3-4" title="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/plot">plot</a></span>(LondonFire, <span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb3-5" title="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/plot">plot</a></span>(LondonBoroughs, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb3-6" title="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/plot">plot</a></span>(LondonFStations, <span class="dt">col =</span> <span class="st">"blue"</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">pch =</span> <span class="dv">16</span>)</a></code></pre></div>
<p><img src="cox_files/figure-html/unnamed-chunk-2-1.png" width="60%" style="display: block; margin: auto;"></p>
</div>
<div id="estimation" class="section level2">
<h2 class="hasAnchor">
<a href="#estimation" class="anchor"></a>Estimation</h2>
<p>The Cox model is implemented in the <code><a href="../reference/family.bamlss.html">cox_bamlss()</a></code> family and uses a special optimizer function <code><a href="../reference/cox.mode.html">cox_mode()</a></code> and sampling engine <code><a href="../reference/cox.mcmc.html">cox_mcmc()</a></code>. Note that the optimizer and sampler function do not need to be called explicitly within the <code><a href="../reference/bamlss.html">bamlss()</a></code> wrapper call, because the <code><a href="../reference/family.bamlss.html">cox_bamlss()</a></code> family specifies this already in its return value, such that internally function <code><a href="../reference/bamlss.html">bamlss()</a></code> nows to only use the estimation engines that are supplied by the family.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">fam &lt;-<span class="st"> </span><span class="kw"><a href="../reference/family.bamlss.html">cox_bamlss</a></span>()</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(fam)</a></code></pre></div>
<pre><code>## [1] "family"    "names"     "links"     "transform" "optimizer" "sampler"  
## [7] "predict"</code></pre>
<p>There is also an additional transformer function, which is needed for computing the (numerical) integrals that are part of the log-likelihood. Predictions are also based on integrals, therefore the <code><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict()</a></code> function is also part of this family object and will be used by <code><a href="../reference/predict.bamlss.html">predict.bamlss()</a></code> instead of the default methods.</p>
<p>The model formula has two parts, the time-dependent for <span class="math inline">\(\eta_{\lambda}\)</span> and the time-constant part for <span class="math inline">\(\eta_{\gamma}\)</span> and can be set up with</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">f &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb6-2" title="2">  <span class="kw">Surv</span>(arrivaltime) <span class="op">~</span><span class="st"> </span><span class="kw">ti</span>(arrivaltime,<span class="dt">k=</span><span class="dv">20</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ti</span>(arrivaltime,lon,lat,<span class="dt">d=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>),<span class="dt">k=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">5</span>,<span class="dv">30</span>)),</a>
<a class="sourceLine" id="cb6-3" title="3">  gamma <span class="op">~</span><span class="st"> </span><span class="kw">s</span>(fsintens) <span class="op">+</span><span class="st"> </span><span class="kw">ti</span>(daytime,<span class="dt">bs=</span><span class="st">"cc"</span>,<span class="dt">k=</span><span class="dv">30</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ti</span>(lon,lat,<span class="dt">k=</span><span class="dv">80</span>,<span class="dt">d=</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="st">    </span><span class="kw">ti</span>(daytime,lon,lat,<span class="dt">bs=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"cc"</span>,<span class="st">"cr"</span>),<span class="dt">d=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>),<span class="dt">k=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">10</span>,<span class="dv">30</span>))</a>
<a class="sourceLine" id="cb6-5" title="5">)</a></code></pre></div>
<p>Note that the <code>Surv()</code> function from the <em>survival</em> package <span class="citation">(Therneau 2019)</span> is used to set up the formula for <span class="math inline">\(\eta_{\lambda}\)</span>. Also note that the arrival times are not censored in this application. The model is estimated with</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="co">## Set the seed for reproducibility.</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">222</span>)</a>
<a class="sourceLine" id="cb7-3" title="3"></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="co">## Start estimation</span></a>
<a class="sourceLine" id="cb7-5" title="5">firemodel &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bamlss.html">bamlss</a></span>(f, <span class="dt">data =</span> LondonFire, <span class="dt">family =</span> <span class="st">"cox"</span>,</a>
<a class="sourceLine" id="cb7-6" title="6">  <span class="dt">subdivisions =</span> <span class="dv">25</span>, <span class="dt">maxit =</span> <span class="dv">1000</span>,</a>
<a class="sourceLine" id="cb7-7" title="7">  <span class="dt">n.iter =</span> <span class="dv">6000</span>, <span class="dt">burnin =</span> <span class="dv">3000</span>, <span class="dt">thin =</span> <span class="dv">20</span>, <span class="dt">cores =</span> <span class="dv">8</span>)</a></code></pre></div>
<p>Note, due to the complexity of the model and model terms estimation takes quite long. On a Linux system with 8 Intel i7-2600 3.40GHz processors estimation takes approximately 1.2 days.</p>
<p>Good practice after fitting the model is to do some convergence checks of the MCMC chains, e.g., by looking at traceplots</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/plot">plot</a></span>(firemodel, <span class="dt">which =</span> <span class="st">"samples"</span>)</a></code></pre></div>
<p><img src="cox_files/figure-html/unnamed-chunk-7-1.png" width="80%" style="display: block; margin: auto;"> Note, for convenience we only show the traceplot of the intercept term of predictor <span class="math inline">\(\eta_{\gamma}\)</span>. The traceplot indicates convergence of the MCMC chains and have close to i.i.d. behavior. The model summary gives</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(firemodel)</a></code></pre></div>
<pre><code>## 
## Call:
## bamlss(formula = f, family = "cox", data = LondonFire, cores = 8, 
##     subdivisions = 25, maxit = 1000, n.iter = 6000, burnin = 3000, 
##     thin = 20)
## ---
## Family: cox 
## Link function: lambda = log, gamma = log
## *---
## Formula lambda:
## ---
## Surv(arrivaltime) ~ ti(arrivaltime, k = 20) + ti(arrivaltime, 
##     lon, lat, d = c(1, 2), k = c(5, 30))
## -
## Smooth terms:
##                                    Mean      2.5%       50%     97.5%
## ti(arrivaltime).tau21         2.087e-02 5.443e-03 1.717e-02 5.698e-02
## ti(arrivaltime).edf           1.319e+01 1.061e+01 1.317e+01 1.585e+01
## ti(arrivaltime).alpha         7.017e-01 7.428e-04 8.238e-01 1.000e+00
## ti(arrivaltime,lon,lat).tau21 2.742e-03 3.547e-05 1.731e-04 6.251e-03
## ti(arrivaltime,lon,lat).tau22 1.256e+02 3.188e+01 1.062e+02 3.061e+02
## ti(arrivaltime,lon,lat).edf   1.369e+01 8.909e+00 1.360e+01 1.839e+01
## ti(arrivaltime,lon,lat).alpha 7.107e-01 1.755e-03 8.394e-01 1.000e+00
##                               parameters
## ti(arrivaltime).tau21              0.117
## ti(arrivaltime).edf               16.853
## ti(arrivaltime).alpha                 NA
## ti(arrivaltime,lon,lat).tau21      1.442
## ti(arrivaltime,lon,lat).tau22    100.714
## ti(arrivaltime,lon,lat).edf       24.858
## ti(arrivaltime,lon,lat).alpha         NA
## ---
## Formula gamma:
## ---
## gamma ~ s(fsintens) + ti(daytime, bs = "cc", k = 30) + ti(lon, 
##     lat, k = 80, d = 2) + ti(daytime, lon, lat, bs = c("cc", 
##     "cr"), d = c(1, 2), k = c(10, 30))
## -
## Parametric coefficients:
##                Mean    2.5%     50%   97.5% parameters
## (Intercept) -0.9501 -0.9773 -0.9499 -0.9234     -0.941
## -
## Acceptance probability:
##         Mean   2.5%    50% 97.5%
## alpha 0.9932 0.9398 0.9999     1
## -
## Smooth terms:
##                                Mean      2.5%       50%     97.5% parameters
## s(fsintens).tau21         9.083e+00 1.746e+00 6.596e+00 2.919e+01      8.171
## s(fsintens).edf           7.381e+00 5.954e+00 7.439e+00 8.504e+00      7.638
## s(fsintens).alpha         9.048e-01 4.122e-01 9.785e-01 1.000e+00         NA
## ti(daytime).tau21         3.385e-02 1.703e-04 8.700e-04 4.559e-02      0.000
## ti(daytime).edf           1.094e+01 6.215e+00 9.916e+00 2.201e+01      6.461
## ti(daytime).alpha         9.176e-01 5.090e-01 9.856e-01 1.000e+00         NA
## ti(lon,lat).tau21         4.313e+00 2.161e+00 4.049e+00 7.642e+00      7.714
## ti(lon,lat).edf           5.794e+01 4.940e+01 5.806e+01 6.489e+01     65.221
## ti(lon,lat).alpha         4.695e-01 1.428e-03 3.702e-01 1.000e+00         NA
## ti(daytime,lon,lat).tau21 3.245e+00 2.595e-01 1.928e+00 1.464e+01      0.000
## ti(daytime,lon,lat).tau22 5.289e+00 8.305e-01 3.856e+00 1.770e+01      0.000
## ti(daytime,lon,lat).edf   3.846e+01 2.034e+01 3.763e+01 6.181e+01      0.013
## ti(daytime,lon,lat).alpha 7.939e-01 1.493e-01 9.154e-01 1.000e+00         NA
## ---
## Sampler summary:
## -
## DIC = 22636.5 logLik = -11247.03 logPost = -10031.52
## pd = 142.4373
## ---
## Optimizer summary:
## -
## AICc = 22607.29 edf = 122.0436 logLik = -11178.97
## logPost = -8898.27 time = 14443.76
## ---</code></pre>
<p>and indicates that the three-dimensional effects in <code>lambda</code> and <code>gamma</code> have an effect on the response times. The estimated effects can be plotted with</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mar =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">4.5</span>, <span class="dv">4</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>), <span class="dt">mfrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">2</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb11-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/plot">plot</a></span>(firemodel, <span class="dt">scale =</span> <span class="dv">0</span>)</a></code></pre></div>
<p><img src="cox_files/figure-html/unnamed-chunk-10-1.png" width="80%" style="display: block; margin: auto;"> The upper left plot shows the estimated baseline hazard effect. The upper right plot the time-constant effect of fire station intensity. The lower left plot the estimated effect of the time of the day and the lower right plot the estimated time-constant spatial effect.</p>
</div>
<div id="prediction" class="section level2">
<h2 class="hasAnchor">
<a href="#prediction" class="anchor"></a>Prediction</h2>
<p>Predictions in for an estimated Cox model are based on the custom predict function <code><a href="../reference/cox.predict.html">cox_predict()</a></code>. Here, predicted probabilities are based on numerical integration, therefore, the user can specify the subdivisions that are used in the integration routine. For example, let’s pick a sample location within the boundaries of London and predict the corresponding probability that the fire engine arrives at 15pm within 0 to 20 minutes.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="co">## Extract the 150th sample.</span></a>
<a class="sourceLine" id="cb12-2" title="2">i &lt;-<span class="st"> </span><span class="dv">150</span></a>
<a class="sourceLine" id="cb12-3" title="3"></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="co">## Create a new data frame for prediction.</span></a>
<a class="sourceLine" id="cb12-5" title="5">nd &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(</a>
<a class="sourceLine" id="cb12-6" title="6">  <span class="st">"arrivaltime"</span> =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">0</span>, <span class="dv">20</span>, <span class="dt">length =</span> <span class="dv">100</span>),</a>
<a class="sourceLine" id="cb12-7" title="7">  <span class="st">"daytime"</span> =<span class="st"> </span><span class="dv">15</span></a>
<a class="sourceLine" id="cb12-8" title="8">)</a>
<a class="sourceLine" id="cb12-9" title="9">nd<span class="op">$</span>fsintens &lt;-<span class="st"> </span>LondonFire<span class="op">$</span>fsintens[i]</a>
<a class="sourceLine" id="cb12-10" title="10">nd<span class="op">$</span>lon &lt;-<span class="st"> </span>LondonFire<span class="op">$</span>lon[i]</a>
<a class="sourceLine" id="cb12-11" title="11">nd<span class="op">$</span>lat &lt;-<span class="st"> </span>LondonFire<span class="op">$</span>lat[i]</a>
<a class="sourceLine" id="cb12-12" title="12"></a>
<a class="sourceLine" id="cb12-13" title="13"><span class="co">## Predict probabilities.</span></a>
<a class="sourceLine" id="cb12-14" title="14">nd<span class="op">$</span>p &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/t">t</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(firemodel, <span class="dt">newdata =</span> nd,</a>
<a class="sourceLine" id="cb12-15" title="15">  <span class="dt">type =</span> <span class="st">"probabilities"</span>, <span class="dt">subdivisions =</span> <span class="dv">100</span>, <span class="dt">FUN =</span> c95))</a></code></pre></div>
<p>The estimated probabilities that the fire engine arrives in <span class="math inline">\(t\)</span> minutes can then be plotted with</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mar =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>))</a>
<a class="sourceLine" id="cb13-2" title="2"><span class="kw"><a href="../reference/plot2d.html">plot2d</a></span>(p <span class="op">~</span><span class="st"> </span>arrivaltime, <span class="dt">data =</span> nd, <span class="dt">ylab =</span> <span class="st">"1 - Prob(T &gt; t)"</span>)</a></code></pre></div>
<p><img src="cox_files/figure-html/unnamed-chunk-12-1.png" width="50%" style="display: block; margin: auto;"></p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-bamlss:Taylor:2015">
<p>Taylor, Benjamin M. 2017. “Spatial Modelling of Emergency Service Response Times.” <em>Journal of the Royal Statistical Society A</em>. <a href="https://doi.org/10.1111/rssa.12192" class="uri">https://doi.org/10.1111/rssa.12192</a>.</p>
</div>
<div id="ref-bamlss:Therneau:2016">
<p>Therneau, T. M. 2019. <em>survival: A Package for Survival Analysis in S</em>. <a href="https://CRAN.R-project.org/package=survival" class="uri">https://CRAN.R-project.org/package=survival</a>.</p>
</div>
<div id="ref-bamlss:Umlauf+Klein+Zeileis:2017">
<p>Umlauf, Nikolaus, Nadja Klein, and Achim Zeileis. 2018. “BAMLSS: Bayesian Additive Models for Location, Scale and Shape (and Beyond).” <em>Journal of Computational and Graphical Statistics</em> 27 (3): 612–27. <a href="https://doi.org/10.1080/10618600.2017.1407325" class="uri">https://doi.org/10.1080/10618600.2017.1407325</a>.</p>
</div>
<div id="ref-bamlss:Umlauf+bamlss:2018">
<p>Umlauf, Nikolaus, Nadja Klein, Achim Zeileis, and Thorsten Simon. 2021. <em>bamlss: Bayesian Additive Models for Location Scale and Shape (and Beyond)</em>. <a href="https://CRAN.R-project.org/package=bamlss" class="uri">https://CRAN.R-project.org/package=bamlss</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#intro">Intro</a></li>
      <li><a href="#model">Model</a></li>
      <li><a href="#data">Data</a></li>
      <li><a href="#estimation">Estimation</a></li>
      <li><a href="#prediction">Prediction</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Nikolaus Umlauf, Nadja Klein, Achim Zeileis, Thorsten Simon.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
